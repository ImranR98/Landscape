apiVersion: apps/v1
kind: Deployment
metadata:
  name: mosquitto
  namespace: production
  labels:
    app: mosquitto
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mosquitto
  template:
    metadata:
      labels:
        app: mosquitto
    spec:
      securityContext:
        runAsUser: 1000 # For some reason this must be hardcoded, using $MY_UID then running envsubst causes a permission error
        runAsGroup: 1000 # As above (unsure which of the 3 is the problem)
        fsGroup: 1000 # The only other workaround is to disable 'defaultMode' below but that will fail in future versions
      containers:
        - name: mosquitto
          image: eclipse-mosquitto:openssl
          ports:
            - containerPort: 1883
            - containerPort: 8883
            - containerPort: 9001
          volumeMounts:
            - name: mosquitto-secrets
              mountPath: /mosquitto/config/certificate.pem
              subPath: certificate.pem
            - name: mosquitto-secrets
              mountPath: /mosquitto/config/private_key.pem
              subPath: private_key.pem
            - name: mosquitto-secrets
              mountPath: /mosquitto/config/password_file
              subPath: password_file
            - name: mosquitto-config
              mountPath: /mosquitto/config/mosquitto.conf
              subPath: mosquitto.conf
            - name: data
              mountPath: /mosquitto/data
              subPath: data
      volumes:
        - name: mosquitto-secrets
          secret:
            secretName: mosquitto
            defaultMode: 448
            items:
              - key: private_key.pem
                path: private_key.pem
              - key: certificate.pem
                path: certificate.pem
              - key: password_file
                path: password_file
        - name: mosquitto-config
          configMap:
            name: mosquitto
            items:
              - key: mosquitto.conf
                path: mosquitto.conf
        - name: data
          persistentVolumeClaim:
            claimName: mosquitto-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mosquitto
  namespace: production
  labels:
    app: mosquitto
spec:
  selector:
    app: mosquitto
  ports:
    - name: listener
      protocol: TCP
      port: 1883
      targetPort: 1883
    - name: listener-tls
      protocol: TCP
      port: 8883
      targetPort: 8883
    - name: websocket
      protocol: TCP
      port: 9001
      targetPort: 9001
  type: ClusterIP
