apiVersion: apps/v1
kind: Deployment
metadata:
  name: mosquitto
  namespace: production
  labels:
    app: mosquitto
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mosquitto
  template:
    metadata:
      labels:
        app: mosquitto
    spec:
      securityContext:
        runAsUser: $MY_UID
        runAsGroup: $MY_UID
        fsGroup: $MY_UID
      containers:
        - name: mosquitto
          image: eclipse-mosquitto:openssl
          ports:
            - containerPort: 1883
            - containerPort: 8883
            - containerPort: 9001
          volumeMounts:
            - name: mosquitto-secrets
              mountPath: /mosquitto/config/certificate.pem
              subPath: certificate.pem
            - name: mosquitto-secrets
              mountPath: /mosquitto/config/private_key.pem
              subPath: private_key.pem
            - name: mosquitto-secrets
              mountPath: /mosquitto/config/password_file
              subPath: password_file
            - name: mosquitto-config
              mountPath: /mosquitto/config/mosquitto.conf
              subPath: mosquitto.conf
            - name: data
              mountPath: /mosquitto/data
              subPath: data
          securityContext:
            allowPrivilegeEscalation: false
            seLinuxOptions:
              type: spc_t # SELinux may cause issues with file watching/reading for external libraries
      volumes:
        - name: mosquitto-secrets
          secret:
            secretName: mosquitto
            defaultMode: 448
            items:
              - key: private_key.pem
                path: private_key.pem
              - key: certificate.pem
                path: certificate.pem
              - key: password_file
                path: password_file
        - name: mosquitto-config
          configMap:
            name: mosquitto
            items:
              - key: mosquitto.conf
                path: mosquitto.conf
        - name: data
          persistentVolumeClaim:
            claimName: mosquitto-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mosquitto
  namespace: production
  labels:
    app: mosquitto
spec:
  selector:
    app: mosquitto
  ports:
    - name: listener
      protocol: TCP
      port: 1883
      targetPort: 1883
    - name: listener-tls
      protocol: TCP
      port: 8883
      targetPort: 8883
    - name: websocket
      protocol: TCP
      port: 9001
      targetPort: 9001
  type: ClusterIP
